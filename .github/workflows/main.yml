name: Monthly Finance Bot

on:
  schedule:
    # 计划任务：国际标准时间每月1号的09:00运行 (对应北京时间下午17:00)
    # 格式：分 时 日 月 周
    - cron: '0 9 1,15 * *'  # 每月1号和15号运行
  workflow_dispatch: # 允许手动点击按钮触发测试

permissions:
  contents: write # 赋予写权限，以便把数据库推回仓库

jobs:
  run_bot:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.9'

    - name: Install dependencies
      run: |
        pip install feedparser

    - name: Run Bot Script
      env:
        SENDER_EMAIL: ${{ secrets.SENDER_EMAIL }}
        SENDER_PASSWORD: ${{ secrets.SENDER_PASSWORD }}
        RECEIVER_EMAIL: ${{ secrets.RECEIVER_EMAIL }}
      run: python main.py

- name: Commit and Push DB changes
      run: |
        git config --global user.name "GitHub Action Bot"
        git config --global user.email "actions@github.com"
        
        # 1. 先把本地的新数据库添加进暂存区
        git add finance_journals.db
        
        # 2. 尝试提交（如果没有变化就不提交）
        git commit -m "Update database records [skip ci]" || exit 0
        
        # 3. 【关键步骤】拉取云端最新的代码，并把我们的修改“叠加”在上面 (Rebase)
        git pull --rebase origin main
        
        # 4. 最后再推送
        git push
